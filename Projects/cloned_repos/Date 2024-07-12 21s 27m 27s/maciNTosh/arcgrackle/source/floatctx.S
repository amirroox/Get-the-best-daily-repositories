#define _LANGUAGE_ASSEMBLY
#include "asm.h"

	.set	FP_SIZE,	8

	.set	GP_SRR0, (SRR0_OFFSET - 8)
	.set	GP_SRR1, (GP_SRR0 + 4)

	.set	GP_1, (GPR1_OFFSET - 8)
	.set	GP_2, (GP_1 + 4)
#ifdef _DEBUG
	.set	GP_5, (GPR5_OFFSET - 8)
	.set	GP_6, (GP_5 + 4)
#endif
	.set	GP_13, (GPR13_OFFSET - 8)
	.set	GP_14, (GP_13 + 4)
	.set	GP_15, (GP_14 + 4)
	.set	GP_16, (GP_15 + 4)
	.set	GP_17, (GP_16 + 4)
	.set	GP_18, (GP_17 + 4)
	.set	GP_19, (GP_18 + 4)
	.set	GP_20, (GP_19 + 4)
	.set	GP_21, (GP_20 + 4)
	.set	GP_22, (GP_21 + 4)
	.set	GP_23, (GP_22 + 4)
	.set	GP_24, (GP_23 + 4)
	.set	GP_25, (GP_24 + 4)
	.set	GP_26, (GP_25 + 4)
	.set	GP_27, (GP_26 + 4)
	.set	GP_28, (GP_27 + 4)
	.set	GP_29, (GP_28 + 4)
	.set	GP_30, (GP_29 + 4)
	.set	GP_31, (GP_30 + 4)

	.set	GQ_0, (GP_31 + 4)
	.set	GQ_1, (GQ_0 + 4)
	.set	GQ_2, (GQ_1 + 4)
	.set	GQ_3, (GQ_2 + 4)
	.set	GQ_4, (GQ_3 + 4)
	.set	GQ_5, (GQ_4 + 4)
	.set	GQ_6, (GQ_5 + 4)
	.set	GQ_7, (GQ_6 + 4)

	.set	GP_CR, (GQ_7 + 4)
	.set	GP_LR, (GP_CR + 4)
	.set	GP_CTR, (GP_LR + 4)
	.set	GP_XER, (GP_CTR + 4)
	.set	GP_MSR, (GP_XER + 4)
	.set	GP_DAR, (GP_MSR + 4)

	.set	STATE, (GP_DAR + 4)
	.set	MODE, (STATE + 2)

	.set	FP_0, (FPR0_OFFSET - 8)
	.set	FP_1, (FP_0 + FP_SIZE)
	.set	FP_2, (FP_1 + FP_SIZE)
	.set	FP_3, (FP_2 + FP_SIZE)
	.set	FP_4, (FP_3 + FP_SIZE)
	.set	FP_5, (FP_4 + FP_SIZE)
	.set	FP_6, (FP_5 + FP_SIZE)
	.set	FP_7, (FP_6 + FP_SIZE)
	.set	FP_8, (FP_7 + FP_SIZE)
	.set	FP_9, (FP_8 + FP_SIZE)
	.set	FP_10, (FP_9 + FP_SIZE)
	.set	FP_11, (FP_10 + FP_SIZE)
	.set	FP_12, (FP_11 + FP_SIZE)
	.set	FP_13, (FP_12 + FP_SIZE)
	.set	FP_14, (FP_13 + FP_SIZE)
	.set	FP_15, (FP_14 + FP_SIZE)
	.set	FP_16, (FP_15 + FP_SIZE)
	.set	FP_17, (FP_16 + FP_SIZE)
	.set	FP_18, (FP_17 + FP_SIZE)
	.set	FP_19, (FP_18 + FP_SIZE)
	.set	FP_20, (FP_19 + FP_SIZE)
	.set	FP_21, (FP_20 + FP_SIZE)
	.set	FP_22, (FP_21 + FP_SIZE)
	.set	FP_23, (FP_22 + FP_SIZE)
	.set	FP_24, (FP_23 + FP_SIZE)
	.set	FP_25, (FP_24 + FP_SIZE)
	.set	FP_26, (FP_25 + FP_SIZE)
	.set	FP_27, (FP_26 + FP_SIZE)
	.set	FP_28, (FP_27 + FP_SIZE)
	.set	FP_29, (FP_28 + FP_SIZE)
	.set	FP_30, (FP_29 + FP_SIZE)
	.set	FP_31, (FP_30 + FP_SIZE)
	.set	FP_FPSCR, (FP_31 + FP_SIZE)
	.set	PSFP_0, (FP_FPSCR + FP_SIZE)
	.set	PSFP_1, (PSFP_0 + FP_SIZE)
	.set	PSFP_2, (PSFP_1 + FP_SIZE)
	.set	PSFP_3, (PSFP_2 + FP_SIZE)
	.set	PSFP_4, (PSFP_3 + FP_SIZE)
	.set	PSFP_5, (PSFP_4 + FP_SIZE)
	.set	PSFP_6, (PSFP_5 + FP_SIZE)
	.set	PSFP_7, (PSFP_6 + FP_SIZE)
	.set	PSFP_8, (PSFP_7 + FP_SIZE)
	.set	PSFP_9, (PSFP_8 + FP_SIZE)
	.set	PSFP_10, (PSFP_9 + FP_SIZE)
	.set	PSFP_11, (PSFP_10 + FP_SIZE)
	.set	PSFP_12, (PSFP_11 + FP_SIZE)
	.set	PSFP_13, (PSFP_12 + FP_SIZE)
	.set	PSFP_14, (PSFP_13 + FP_SIZE)
	.set	PSFP_15, (PSFP_14 + FP_SIZE)
	.set	PSFP_16, (PSFP_15 + FP_SIZE)
	.set	PSFP_17, (PSFP_16 + FP_SIZE)
	.set	PSFP_18, (PSFP_17 + FP_SIZE)
	.set	PSFP_19, (PSFP_18 + FP_SIZE)
	.set	PSFP_20, (PSFP_19 + FP_SIZE)
	.set	PSFP_21, (PSFP_20 + FP_SIZE)
	.set	PSFP_22, (PSFP_21 + FP_SIZE)
	.set	PSFP_23, (PSFP_22 + FP_SIZE)
	.set	PSFP_24, (PSFP_23 + FP_SIZE)
	.set	PSFP_25, (PSFP_24 + FP_SIZE)
	.set	PSFP_26, (PSFP_25 + FP_SIZE)
	.set	PSFP_27, (PSFP_26 + FP_SIZE)
	.set	PSFP_28, (PSFP_27 + FP_SIZE)
	.set	PSFP_29, (PSFP_28 + FP_SIZE)
	.set	PSFP_30, (PSFP_29 + FP_SIZE)
	.set	PSFP_31, (PSFP_30 + FP_SIZE)

	.align	5
	.globl _cpu_context_save_fp
_cpu_context_save_fp:
	lhz		r4,STATE(r3)
	ori		r4,r4,0x0001
	sth		r4,STATE(r3)
	stfd	fr0, FP_0(r3)
	stfd	fr1, FP_1(r3)
	stfd	fr2, FP_2(r3)
	stfd	fr3, FP_3(r3)
	stfd	fr4, FP_4(r3)
	stfd	fr5, FP_5(r3)
	stfd	fr6, FP_6(r3)
	stfd	fr7, FP_7(r3)
	stfd	fr8, FP_8(r3)
	stfd	fr9, FP_9(r3)
	stfd	fr10, FP_10(r3)
	stfd	fr11, FP_11(r3)
	stfd	fr12, FP_12(r3)
	stfd	fr13, FP_13(r3)
	stfd	fr14, FP_14(r3)
	stfd	fr15, FP_15(r3)
	stfd	fr16, FP_16(r3)
	stfd	fr17, FP_17(r3)
	stfd	fr18, FP_18(r3)
	stfd	fr19, FP_19(r3)
	stfd	fr20, FP_20(r3)
	stfd	fr21, FP_21(r3)
	stfd	fr22, FP_22(r3)
	stfd	fr23, FP_23(r3)
	stfd	fr24, FP_24(r3)
	stfd	fr25, FP_25(r3)
	stfd	fr26, FP_26(r3)
	stfd	fr27, FP_27(r3)
	stfd	fr28, FP_28(r3)
	stfd	fr29, FP_29(r3)
	stfd	fr30, FP_30(r3)
	stfd	fr31, FP_31(r3)
	mffs	fr0
	stfd	fr0, FP_FPSCR(r3)
	lfd		fr0, FP_0(r3)
1:	blr

	.align	5
	.globl _cpu_context_restore_fp
_cpu_context_restore_fp:
	lhz		r4,STATE(r3)
	clrlwi.	r4,r4,31
	beq		2f
	lfd		fr0, FP_FPSCR(r3)
	mtfsf	255, fr0
	lfd		fr0, FP_0(r3)
	lfd		fr1, FP_1(r3)
	lfd		fr2, FP_2(r3)
	lfd		fr3, FP_3(r3)
	lfd		fr4, FP_4(r3)
	lfd		fr5, FP_5(r3)
	lfd		fr6, FP_6(r3)
	lfd		fr7, FP_7(r3)
	lfd		fr8, FP_8(r3)
	lfd		fr9, FP_9(r3)
	lfd		fr10, FP_10(r3)
	lfd		fr11, FP_11(r3)
	lfd		fr12, FP_12(r3)
	lfd		fr13, FP_13(r3)
	lfd		fr14, FP_14(r3)
	lfd		fr15, FP_15(r3)
	lfd		fr16, FP_16(r3)
	lfd		fr17, FP_17(r3)
	lfd		fr18, FP_18(r3)
	lfd		fr19, FP_19(r3)
	lfd		fr20, FP_20(r3)
	lfd		fr21, FP_21(r3)
	lfd		fr22, FP_22(r3)
	lfd		fr23, FP_23(r3)
	lfd		fr24, FP_24(r3)
	lfd		fr25, FP_25(r3)
	lfd		fr26, FP_26(r3)
	lfd		fr27, FP_27(r3)
	lfd		fr28, FP_28(r3)
	lfd		fr29, FP_29(r3)
	lfd		fr30, FP_30(r3)
	lfd		fr31, FP_31(r3)
2:	blr